<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>完了済み一覧</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    let currentSortKey = null;
    let currentSortAsc = true;

    function loadRecords() {
      return JSON.parse(localStorage.getItem("completedRecords") || "[]");
    }

    function displayRecords(records) {
      const tbody = document.getElementById("recordTable");
      tbody.innerHTML = "";
      records.forEach(record => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="p-2 border">${record.date}</td>
          <td class="p-2 border">${record.duration}</td>
          <td class="p-2 border">${record.location || ""}</td>
          <td class="p-2 border">${record.mode || ""}</td>
          <td class="p-2 border">${record.carNumber}</td>
          <td class="p-2 border">${record.company || ""}</td>
          <td class="p-2 border">${record.brand || ""}</td>
          <td class="p-2 border">${record.tankNumber || ""}</td>
          <td class="p-2 border">${record.remarks || ""}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function filterRecords() {
      const from = document.getElementById("searchFrom").value;
      const to = document.getElementById("searchTo").value;
      const car = document.getElementById("searchCar").value.trim();
      const company = document.getElementById("searchCompany").value.trim();
      const tank = document.getElementById("searchTank").value.trim();

      const all = loadRecords();
      const filtered = all.filter(r => {
        const matchDate = (!from || r.date >= from) && (!to || r.date <= to);
        const matchCar = !car || r.carNumber.includes(car);
        const matchCompany = !company || (r.company && r.company.includes(company));
        const matchTank = !tank || (r.tankNumber && r.tankNumber.includes(tank));
        return matchDate && matchCar && matchCompany && matchTank;
      });

      if (currentSortKey) {
        filtered.sort((a, b) => {
          if (a[currentSortKey] < b[currentSortKey]) return currentSortAsc ? -1 : 1;
          if (a[currentSortKey] > b[currentSortKey]) return currentSortAsc ? 1 : -1;
          return 0;
        });
      }

      displayRecords(filtered);
    }

    function sortBy(key) {
      if (currentSortKey === key) {
        currentSortAsc = !currentSortAsc;
      } else {
        currentSortKey = key;
        currentSortAsc = true;
      }
      filterRecords();
    }

    function toggleAdvancedSearch() {
      const adv = document.getElementById("advancedSearch");
      adv.classList.toggle("hidden");
    }

    window.onload = () => {
      filterRecords();
    }
  </script>
</head>
<body class="bg-gray-100 p-4 text-sm">
  <div class="max-w-7xl mx-auto bg-white p-4 rounded-xl shadow">
    <h1 class="text-lg font-bold mb-4 text-center">✅ 完了済み一覧</h1>

    <!-- 検索条件エリア -->
    <div class="space-y-2 mb-4">
      <div class="flex flex-wrap items-center gap-2">
        <label class="text-gray-700 font-semibold">📅 日付</label>
        <input id="searchFrom" type="date" class="p-2 border rounded" />
        <span class="text-gray-600">〜</span>
        <input id="searchTo" type="date" class="p-2 border rounded" />
        <button onclick="toggleAdvancedSearch()" class="ml-4 text-blue-600 underline">+ 詳細検索</button>
      </div>

      <div id="advancedSearch" class="hidden grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-2">
        <select id="searchLocation" class="p-2 border rounded">
          <option value="">📍 場所を選択</option>
          <option value="清水工場">清水工場</option>
          <option value="鹿島工場">鹿島工場</option>
          <option value="石巻工場">石巻工場</option>
        </select>
        <select id="searchMode" class="p-2 border rounded">
          <option value="">📦 出荷 or 受入</option>
          <option value="出荷">出荷</option>
          <option value="受入">受入</option>
        </select>
        <input id="searchCar" type="text" class="p-2 border rounded w-full" placeholder="🚚 車両番号で検索" />
        <input id="searchCompany" type="text" class="p-2 border rounded w-full" placeholder="🏢 運送会社で検索" />
        <input id="searchBrand" type="text" class="p-2 border rounded w-full" placeholder="🧪 銘柄で検索" />
        <input id="searchTank" type="text" class="p-2 border rounded w-full" placeholder="🛢 タンクNo.で検索" />
      </div>

      <div class="flex flex-wrap gap-2 mt-2">
        <button onclick="filterRecords()" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">← 検索する</button>
        <button onclick="copyToClipboard()" class="bg-yellow-500 text-white py-2 px-4 rounded hover:bg-yellow-600">📋 クリップボード出力</button>
      </div>
    </div>

    <!-- 一覧テーブル -->
    <div class="overflow-x-auto">
      <table class="min-w-full table-auto border text-sm">
        <thead>
          <tr class="bg-gray-200 text-left">
            <th class="p-2 border cursor-pointer" onclick="sortBy('date')">日付</th>
            <th class="p-2 border cursor-pointer" onclick="sortBy('duration')">計測時間</th>
            <th class="p-2 border cursor-pointer" onclick="sortBy('location')">場所</th>
            <th class="p-2 border cursor-pointer" onclick="sortBy('mode')">出荷/受入</th>
            <th class="p-2 border cursor-pointer" onclick="sortBy('carNumber')">車両番号</th>
            <th class="p-2 border cursor-pointer" onclick="sortBy('company')">運送会社</th>
            <th class="p-2 border cursor-pointer" onclick="sortBy('brand')">銘柄</th>
            <th class="p-2 border cursor-pointer" onclick="sortBy('tankNumber')">タンクNo.</th>
            <th class="p-2 border cursor-pointer" onclick="sortBy('remarks')">備考</th>
          </tr>
        </thead>
        <tbody id="recordTable">
          <!-- 動的に挿入 -->
        </tbody>
      </table>
    </div>

    <!-- 戻るリンク -->
    <div class="mt-4 text-center">
      <a href="index.html" class="text-blue-600 underline">← 記録画面に戻る</a>
    </div>
  </div>
</body>
</html>
