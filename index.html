<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>ãƒˆãƒ©ãƒƒã‚¯è·å¾…ã¡æ™‚é–“è¨˜éŒ²</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      font-size: 16px;
      line-height: 1.5;
      background-color: #f3f4f6;
    }
    video#barcodePreview {
      width: 100%;
      border-radius: 0.5rem;
      margin-top: 0.5rem;
    }
    input, select, button {
      font-size: 1rem;
    }
  </style>
</head>
<body class="bg-gray-100 p-4 text-base">
  <div class="max-w-4xl mx-auto bg-white p-4 sm:p-6 rounded-xl shadow space-y-6">
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-bold text-blue-800">ãƒˆãƒ©ãƒƒã‚¯è·å¾…ã¡æ™‚é–“è¨˜éŒ²</h1>
        <div class="text-sm text-gray-500">ğŸ“ æ‰€å±ï¼š<span id="locationDisplay"></span></div>
      </div>
      <div class="flex items-center gap-3">
        <a href="complete.html" class="text-blue-600 underline text-sm">âœ… å®Œäº†æ¸ˆã¿ä¸€è¦§ã‚’è¦‹ã‚‹</a>
        <button onclick="location.reload(true)" class="text-sm text-white bg-gray-600 hover:bg-gray-700 px-3 py-1 rounded shadow">
          ğŸ”„ Reloadï¼ˆæœ€æ–°ç‰ˆã«æ›´æ–°ï¼‰
        </button>
      </div>
    </div>

    <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg text-sm text-gray-700">
      <p class="mb-1 font-semibold">ğŸ“˜ ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ï¼š</p>
      <ul class="list-disc pl-5 space-y-1">
        <li>å‡ºè·No. / å…¥åº«No. ã¯ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šã¾ãŸã¯ä¸€è¦§ç”»é¢ã‹ã‚‰é¸æŠå¯èƒ½ã§ã™ã€‚</li>
        <li>æ“ä½œã¯ã‚¹ãƒãƒ›ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã‚‚å¿«é©ã«è¡Œãˆã¾ã™ã€‚</li>
        <li>è©³ç´°å…¥åŠ›ï¼ˆè»Šç•ªãƒ»é‹é€ä¼šç¤¾ãƒ»éŠ˜æŸ„ãªã©ï¼‰ã¯å¿…è¦ã«å¿œã˜ã¦å±•é–‹ã—ã¦ãã ã•ã„ã€‚</li>
      </ul>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <input id="shipmentNo" class="w-full p-4 text-xl border rounded" placeholder="ğŸ“¦ å‡ºè·No. ã¾ãŸã¯ å…¥åº«No." />
      <button onclick="openBarcodeScanner()" class="bg-green-600 text-white rounded text-xl p-4 hover:bg-green-700">
        ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š
      </button>
    </div>

    <video id="barcodePreview" class="hidden"></video>

    <div>
      <button onclick="openNoSelector()" class="text-sm text-blue-600 underline">ğŸ” å‡ºè·/å…¥åº«No. é¸æŠç”»é¢ã‚’é–‹ã</button>
    </div>

    <div>
      <button onclick="toggleOptionalFields()" class="text-sm text-blue-600 underline mt-2">+ è©³ç´°å…¥åŠ›ã‚’è¡¨ç¤º</button>
    </div>

    <div id="optionalFields" class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
      <input id="carNumber" class="w-full p-4 text-xl border rounded" placeholder="ğŸšš è»Šä¸¡ç•ªå·ï¼ˆä»»æ„ï¼‰" />
      <select id="company" class="w-full p-4 text-xl border rounded">
        <option value="">ğŸ¢ é‹é€ä¼šç¤¾ã‚’é¸æŠ</option>
        <option value="ä¸¸é‹è¼¸">ä¸¸é‹è¼¸</option>
        <option value="æ¸…æ°´ç‰©æµ">æ¸…æ°´ç‰©æµ</option>
      </select>
      <select id="brand" class="w-full p-4 text-xl border rounded">
        <option value="">ğŸ§ª éŠ˜æŸ„ã‚’é¸æŠ</option>
        <option value="é…åˆA">é…åˆA</option>
        <option value="é…åˆB">é…åˆB</option>
      </select>
      <select id="tankNumber" class="w-full p-4 text-xl border rounded">
        <option value="">ğŸ›¢ ã‚¿ãƒ³ã‚¯No.ã‚’é¸æŠ</option>
        <option value="T-1">T-1</option>
        <option value="T-2">T-2</option>
      </select>
      <input id="remarks" class="w-full p-4 text-xl border rounded md:col-span-2" placeholder="ğŸ“ å‚™è€ƒï¼ˆä»»æ„ï¼‰" />
    </div>

    <div>
      <button onclick="startTimer()" id="startButton" class="w-full bg-blue-600 text-white text-2xl font-semibold py-4 rounded-lg hover:bg-blue-700 mt-4">
        â–¶ è¨ˆæ¸¬ã‚¹ã‚¿ãƒ¼ãƒˆ
      </button>
    </div>

    <div>
      <h2 class="text-xl font-bold mb-2">ğŸ“‹ ç¾åœ¨è¨ˆæ¸¬ä¸­ã®è¨˜éŒ²</h2>
      <div id="timerList" class="space-y-4"></div>
    </div>
  </div>

  <script>
    const CURRENT_USER_LOCATION = 'æ¸…æ°´å·¥å ´';
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('locationDisplay').textContent = CURRENT_USER_LOCATION;
    });

    function toggleOptionalFields() {
      document.getElementById("optionalFields").classList.toggle("hidden");
    }

    function openNoSelector() {
      const exampleNo = prompt("å‡ºè·No.ã¾ãŸã¯å…¥åº«No.ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šS12345ï¼‰");
      if (exampleNo) document.getElementById('shipmentNo').value = exampleNo;
    }

    let codeReader;
    async function openBarcodeScanner() {
      const preview = document.getElementById('barcodePreview');
      preview.classList.remove('hidden');
      codeReader = new ZXing.BrowserMultiFormatReader();

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        preview.srcObject = stream;
        preview.play();

        codeReader.decodeFromVideoDevice(null, 'barcodePreview', (result, err) => {
          if (result) {
            document.getElementById('shipmentNo').value = result.text;
            codeReader.reset();
            preview.classList.add('hidden');
            stream.getTracks().forEach(track => track.stop());
          }
        });
      } catch (err) {
        alert("ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸ: " + err.message);
      }
    }

    function startTimer() {
      const shipmentNo = document.getElementById("shipmentNo").value.trim();
      if (!shipmentNo) {
        alert("å‡ºè·No. ã¾ãŸã¯ å…¥åº«No. ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      const carNumber = document.getElementById("carNumber")?.value || '';
      const company = document.getElementById("company")?.value || '';
      const brand = document.getElementById("brand")?.value || '';
      const tankNumber = document.getElementById("tankNumber")?.value || '';
      const remarks = document.getElementById("remarks")?.value || '';

      const now = new Date();
      const startTime = now.toLocaleTimeString();
      const dateStr = now.toISOString().split("T")[0];

      const container = document.createElement("div");
      container.className = "bg-gray-100 border p-4 rounded-lg";

      let sec = 0;
      let isPaused = false;
      let interval;

      const label = document.createElement("div");
      label.innerHTML = `
        <div class="font-semibold text-lg">No: ${shipmentNo}</div>
        <div class="text-sm text-gray-500">é–‹å§‹æ™‚åˆ»: ${startTime}</div>
        <div class="text-sm text-gray-600">ğŸšš ${carNumber || '-'} ï¼ ğŸ¢ ${company || '-'} ï¼ ğŸ§ª ${brand || '-'} ï¼ ğŸ›¢ ${tankNumber || '-'}</div>
        ${remarks ? `<div class="text-sm text-gray-600">ğŸ“ ${remarks}</div>` : ''}
        <div class="text-3xl mt-2 font-mono text-green-600">â± <span id="time">00:00</span></div>
      `;

      const pauseBtn = document.createElement("button");
      pauseBtn.textContent = "â¸ ä¸€æ™‚åœæ­¢";
      pauseBtn.className = "bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600";

      const stopBtn = document.createElement("button");
      stopBtn.textContent = "â¹ çµ‚äº†";
      stopBtn.className = "bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 ml-2";

      const resetBtn = document.createElement("button");
      resetBtn.textContent = "ğŸ” ãƒªã‚»ãƒƒãƒˆ";
      resetBtn.className = "bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 ml-2";

      const timeEl = label.querySelector("#time");

      function updateTime() {
        const m = String(Math.floor(sec / 60)).padStart(2, "0");
        const s = String(sec % 60).padStart(2, "0");
        timeEl.textContent = `${m}:${s}`;
      }

      interval = setInterval(() => {
        if (!isPaused) {
          sec++;
          updateTime();
        }
      }, 1000);

      pauseBtn.onclick = () => {
        isPaused = !isPaused;
        pauseBtn.textContent = isPaused ? "â–¶ å†é–‹" : "â¸ ä¸€æ™‚åœæ­¢";
        pauseBtn.classList.toggle("bg-green-600", isPaused);
        pauseBtn.classList.toggle("bg-yellow-500", !isPaused);
      };

      resetBtn.onclick = () => {
        if (confirm("âš  ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
          sec = 0;
          updateTime();
        }
      };

      stopBtn.onclick = () => {
        clearInterval(interval);
        container.remove();
        const endTime = new Date().toLocaleTimeString();
        const record = {
          date: dateStr,
          shipmentNo,
          startTime,
          endTime,
          duration: timeEl.textContent,
          carNumber,
          company,
          brand,
          tankNumber,
          remarks
        };
        const data = JSON.parse(localStorage.getItem("completedRecords") || "[]");
        data.push(record);
        localStorage.setItem("completedRecords", JSON.stringify(data));
      };

      const btnGroup = document.createElement("div");
      btnGroup.className = "mt-2 flex flex-wrap gap-2";
      btnGroup.appendChild(pauseBtn);
      btnGroup.appendChild(stopBtn);
      btnGroup.appendChild(resetBtn);

      container.appendChild(label);
      container.appendChild(btnGroup);
      document.getElementById("timerList").appendChild(container);
    }
  </script>
</body>
</html>
