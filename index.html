<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ãƒˆãƒ©ãƒƒã‚¯è·å¾…ã¡æ™‚é–“è¨˜éŒ²</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-size: 16px;
      line-height: 1.5;
      background-color: #f3f4f6;
    }

    video#barcodePreview {
      width: 100%;
      border-radius: 0.5rem;
      margin-top: 0.5rem;
    }

    input,
    select,
    button {
      font-size: 1rem;
    }
  </style>
</head>

<body class="bg-gray-100 p-4 text-base">
  <div class="max-w-4xl mx-auto bg-white p-4 sm:p-6 rounded-xl shadow space-y-6">
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2">
      <div class="flex-1">
        <h1 class="text-2xl font-bold text-blue-800 whitespace-nowrap overflow-hidden text-ellipsis">ãƒˆãƒ©ãƒƒã‚¯è·å¾…ã¡æ™‚é–“è¨˜éŒ²</h1>
        <div class="text-sm text-gray-500">ğŸ“ æ‰€å±ï¼š<span id="locationDisplay"></span></div>
      </div>
      <div class="flex flex-wrap items-center gap-3">
        <a href="complete.html" class="text-blue-600 underline text-sm whitespace-nowrap">âœ… å®Œäº†æ¸ˆã¿ä¸€è¦§ã‚’è¦‹ã‚‹</a>
        <button onclick="location.reload(true)"
          class="text-sm text-white bg-gray-600 hover:bg-gray-700 px-3 py-1 rounded shadow whitespace-nowrap">
          ğŸ”„ Reloadï¼ˆæœ€æ–°ç‰ˆã«æ›´æ–°ï¼‰
        </button>
      </div>
    </div>

    <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg text-sm text-gray-700">
      <p class="mb-1 font-semibold">ğŸ“˜ ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ï¼š</p>
      <ul class="list-disc pl-5 space-y-1">
        <li>å‡ºè·No. / å…¥åº«No. ã¯ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šã¾ãŸã¯ä¸€è¦§ç”»é¢ã‹ã‚‰é¸æŠå¯èƒ½ã§ã™ã€‚</li>
        <li>æ“ä½œã¯ã‚¹ãƒãƒ›ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã‚‚å¿«é©ã«è¡Œãˆã¾ã™ã€‚</li>
        <li>è©³ç´°å…¥åŠ›ï¼ˆè»Šç•ªãƒ»é‹é€ä¼šç¤¾ãƒ»éŠ˜æŸ„ãªã©ï¼‰ã¯å¿…è¦ã«å¿œã˜ã¦å±•é–‹ã—ã¦ãã ã•ã„ã€‚</li>
      </ul>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <input id="shipmentNo" class="w-full p-4 text-xl border rounded" placeholder="ğŸ“¦ å‡ºè·No. ã¾ãŸã¯ å…¥åº«No." />
      <button onclick="openBarcodeScanner()" class="bg-green-600 text-white rounded text-xl p-4 hover:bg-green-700">
        ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š
      </button>
    </div>

    <video id="barcodePreview" class="hidden"></video>

    <div class="flex gap-4">
      <button onclick="openShipmentSelector()" class="text-sm text-blue-600 underline">
        ğŸ” å‡ºè·No.é¸æŠç”»é¢ã‚’é–‹ã
      </button>
      <button onclick="openInboundSelector()" class="text-sm text-blue-600 underline">
        ğŸ” å…¥åº«No.é¸æŠç”»é¢ã‚’é–‹ã
      </button>
    </div>

    <!-- å‡ºè·No. é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="shipmentModal" class="hidden fixed inset-0 z-50">
      <div class="absolute inset-0 bg-black/40" onclick="closeModal('shipmentModal')"></div>
      <div
        class="absolute inset-x-4 top-16 bottom-16 bg-white rounded-xl shadow-lg p-4 overflow-auto max-w-3xl mx-auto">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold">ğŸ“¦ å‡ºè·No.ã‚’é¸æŠ</h3>
          <button class="text-gray-500 hover:text-gray-700" onclick="closeModal('shipmentModal')">âœ•</button>
        </div>
        <div class="mb-3 grid grid-cols-1 sm:grid-cols-5 gap-2 items-end">
          <div>
            <label class="text-xs text-gray-500 block">å‡ºè·æ—¥ From</label>
            <input type="date" id="shipFrom" class="w-full border rounded p-2" />
          </div>
          <div>
            <label class="text-xs text-gray-500 block">å‡ºè·æ—¥ To</label>
            <input type="date" id="shipTo" class="w-full border rounded p-2" />
          </div>
          <div class="sm:col-span-3 text-right">
            <button class="inline-flex items-center px-3 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm"
              onclick="applyShipmentFilter()">æ¤œç´¢</button>
            <button class="inline-flex items-center px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm ml-2"
              onclick="resetShipmentFilter()">ã‚¯ãƒªã‚¢</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-[1400px] w-full text-sm border" id="shipmentTable">
            <thead class="bg-gray-50">
              <tr>
                <th class="border px-2 py-1 text-left cursor-pointer sticky left-0 z-20 bg-gray-50" data-key="no">å‡ºè·No.
                </th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="shipDate">å‡ºè·æ—¥</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="timeBand">æ™‚</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="deliveryDate">å±Šã‘æ—¥</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="customerCode">ï½ºï½°ï¾„ï¾</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="customerName">å¾—æ„å…ˆå</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="destinationName">å±Šã‘å…ˆå</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="productCode">ï½ºï½°ï¾„ï¾</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="productName">è£½å“å</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="status">çŠ¶æ³</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="form">å½¢æ…‹</th>
                <th class="border px-2 py-1 text-right cursor-pointer" data-key="quantity">å€‹æ•°</th>
                <th class="border px-2 py-1 text-right cursor-pointer" data-key="weightKg">é‡é‡(Kg)</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="gate">ï½¹ï¾ï½°ï¾„</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="arrived">å±Š</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="carrierCode">ï½ºï½°ï¾„ï¾</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="carrierName">é‹é€ä¼šç¤¾å</th>
                <th class="border px-2 py-1"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- å…¥åº«No. é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="inboundModal" class="hidden fixed inset-0 z-50">
      <div class="absolute inset-0 bg-black/40" onclick="closeModal('inboundModal')"></div>
      <div
        class="absolute inset-x-4 top-16 bottom-16 bg-white rounded-xl shadow-lg p-4 overflow-auto max-w-3xl mx-auto">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold">ğŸ“¥ å…¥åº«No.ã‚’é¸æŠ</h3>
          <button class="text-gray-500 hover:text-gray-700" onclick="closeModal('inboundModal')">âœ•</button>
        </div>
        <div class="mb-3 grid grid-cols-1 sm:grid-cols-6 gap-2 items-end">
          <div>
            <label class="text-xs text-gray-500 block">å…¥åº«æ—¥ From</label>
            <input type="date" id="inboundFrom" class="w-full border rounded p-2" />
          </div>
          <div>
            <label class="text-xs text-gray-500 block">å…¥åº«æ—¥ To</label>
            <input type="date" id="inboundTo" class="w-full border rounded p-2" />
          </div>
          <div class="sm:col-span-2">
            <label class="text-xs text-gray-500 block">ä»•å…¥å…ˆå</label>
            <input type="text" id="fSupplierName" class="w-full border rounded p-2" placeholder="ä¾‹ï¼‰é§¿æ²³é£¼æ–™" />
          </div>
          <div class="sm:col-span-2">
            <label class="text-xs text-gray-500 block">é‹é€ä¼šç¤¾å</label>
            <input type="text" id="fCarrierName" class="w-full border rounded p-2" placeholder="ä¾‹ï¼‰æ¸¯å—ç‰©æµ" />
          </div>
          <div class="sm:col-span-2">
            <label class="text-xs text-gray-500 block">åŸæ–™å</label>
            <input type="text" id="fMaterialName" class="w-full border rounded p-2" placeholder="ä¾‹ï¼‰é­šç²‰" />
          </div>
          <div class="sm:col-span-6 text-right">
            <button class="inline-flex items-center px-3 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm"
              onclick="applyInboundFilter()">æ¤œç´¢</button>
            <button class="inline-flex items-center px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm ml-2"
              onclick="resetInboundFilter()">ã‚¯ãƒªã‚¢</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-[1400px] w-full text-sm border" id="inboundTable">
            <thead class="bg-gray-50">
              <tr>
                <th class="border px-2 py-1 text-left cursor-pointer sticky left-0 z-20 bg-gray-50"
                  data-key="inboundDate">å…¥åº«æ—¥</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="startTime">é–‹å§‹æ™‚é–“</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="endTime">çµ‚äº†æ™‚é–“</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="supplierCode">ä»•å…¥å…ˆï½ºï½°ï¾„ï¾</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="supplierName">ä»•å…¥å…ˆå</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="carrierCode">é‹é€ä¼šç¤¾ï½ºï½°ï¾„ï¾</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="carrierName">é‹é€ä¼šç¤¾å</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="materialCode">åŸæ–™ï½ºï½°ï¾„ï¾</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="materialName">åŸæ–™å</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="form">å½¢æ…‹</th>
                <th class="border px-2 py-1 text-right cursor-pointer" data-key="weightKg">é‡é‡(kg)</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="cardNo">ï½¶ï½°ï¾„ï¾No.</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="intakeType">å—å…¥å£åŒºåˆ†</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="tanks">æŠ•å…¥ã‚¿ãƒ³ã‚¯</th>
                <th class="border px-2 py-1 text-left cursor-pointer" data-key="inboundNo">å…¥åº«No.</th>
                <th class="border px-2 py-1"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div>
      <button onclick="toggleOptionalFields()" class="text-sm text-blue-600 underline mt-2">+ è©³ç´°å…¥åŠ›ã‚’è¡¨ç¤º</button>
    </div>

    <div id="optionalFields" class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
      <input id="carNumber" class="w-full p-4 text-xl border rounded" placeholder="ğŸšš è»Šä¸¡ç•ªå·ï¼ˆä»»æ„ï¼‰" />
      <select id="company" class="w-full p-4 text-xl border rounded">
        <option value="">ğŸ¢ é‹é€ä¼šç¤¾ã‚’é¸æŠ</option>
        <option value="ä¸¸é‹è¼¸">ä¸¸é‹è¼¸</option>
        <option value="æ¸…æ°´ç‰©æµ">æ¸…æ°´ç‰©æµ</option>
      </select>
      <select id="brand" class="w-full p-4 text-xl border rounded">
        <option value="">ğŸ§ª éŠ˜æŸ„ã‚’é¸æŠ</option>
        <option value="é…åˆA">é…åˆA</option>
        <option value="é…åˆB">é…åˆB</option>
      </select>
      <select id="tankNumber" class="w-full p-4 text-xl border rounded">
        <option value="">ğŸ›¢ ã‚¿ãƒ³ã‚¯No.ã‚’é¸æŠ</option>
        <option value="T-1">T-1</option>
        <option value="T-2">T-2</option>
      </select>
      <input id="remarks" class="w-full p-4 text-xl border rounded md:col-span-2" placeholder="ğŸ“ å‚™è€ƒï¼ˆä»»æ„ï¼‰" />
    </div>

    <div>
      <button onclick="startTimer()" id="startButton"
        class="w-full bg-blue-600 text-white text-2xl font-semibold py-4 rounded-lg hover:bg-blue-700 mt-4">
        â–¶ è¨ˆæ¸¬ã‚¹ã‚¿ãƒ¼ãƒˆ
      </button>
    </div>

    <div>
      <h2 class="text-xl font-bold mb-2">ğŸ“‹ ç¾åœ¨è¨ˆæ¸¬ä¸­ã®è¨˜éŒ²</h2>
      <div id="timerList" class="space-y-4"></div>
    </div>
  </div>

  <script>
    const CURRENT_USER_LOCATION = 'æ¸…æ°´å·¥å ´';
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('locationDisplay').textContent = CURRENT_USER_LOCATION;
    });

    function toggleOptionalFields() {
      document.getElementById("optionalFields").classList.toggle("hidden");
    }

    // <-- å‡ºè·ãƒ»å…¥åº«No.é¸æŠã€€ã“ã“ã‹ã‚‰ -->
    const BASE_DATA = { shipment: [], inbound: [] };
    const SORT_STATE = { shipment: [], inbound: [] };
    // ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆ3è¡Œãšã¤ï¼‰
    const DUMMY_SHIPMENTS = [
      { no: 'S-1001', shipDate: '2025-08-15', timeBand: 'æ—©æœ', deliveryDate: '2025-08-16', customerCode: 'C001', customerName: 'æ¸…æ°´ç•œç”£', destinationName: 'æ¸…æ°´ç¬¬2å€‰åº«', productCode: 'P-11', productName: 'é…åˆA', status: 'å—ä»˜æ¸ˆ', form: 'ãƒãƒ©', quantity: '', weightKg: 12450, gate: '01', arrived: 'å±Š', carrierCode: 'T01', carrierName: 'ä¸¸é‹è¼¸' },
      { no: 'S-1002', shipDate: '2025-08-15', timeBand: 'åˆå‰', deliveryDate: '2025-08-16', customerCode: 'C017', customerName: 'å¯Œå£«ç‰§å ´', destinationName: 'å¯Œå£«å‡ºè·æ‰€', productCode: 'P-21', productName: 'é…åˆB', status: 'å—ä»˜æ¸ˆ', form: 'ç´™è¢‹', quantity: 40, weightKg: 800, gate: '03', arrived: '', carrierCode: 'T12', carrierName: 'æ¸…æ°´ç‰©æµ' },
      { no: 'S-1003', shipDate: '2025-08-15', timeBand: 'åˆå‰', deliveryDate: '2025-08-17', customerCode: 'C102', customerName: 'ç„¼æ´¥ç‰§å ´', destinationName: 'ç„¼æ´¥å€‰åº«', productCode: 'P-31', productName: 'é…åˆC', status: 'å‡ºè·å®Œäº†', form: 'TB', quantity: 2, weightKg: 2000, gate: '02', arrived: 'å±Š', carrierCode: 'T07', carrierName: 'å¯Œå£«é‹é€' },
    ];

    const DUMMY_INBOUNDS = [
      { inboundDate: '2025-08-15', startTime: '09:00', endTime: '09:40', supplierCode: 'S011', supplierName: 'é§¿æ²³é£¼æ–™', carrierCode: 'T21', carrierName: 'é§¿æ²³é‹è¼¸', materialCode: 'M-01', materialName: 'ãƒˆã‚¦ãƒ¢ãƒ­ã‚³ã‚·', form: 'ãƒãƒ©', weightKg: 18000, cardNo: '1', intakeType: 'ç„¡ç²‰ç •', tanks: '207,208', inboundNo: 'I-2001' },
      { inboundDate: '2025-08-15', startTime: '10:30', endTime: '11:10', supplierCode: 'S034', supplierName: 'æ±æµ·ãƒŸãƒ¼ãƒ«', carrierCode: 'T09', carrierName: 'æ¸¯å—ç‰©æµ', materialCode: 'M-19', materialName: 'é­šç²‰', form: 'è¢‹ç‰©', weightKg: 900, cardNo: '5', intakeType: 'è¦ç²‰ç •', tanks: '003', inboundNo: 'I-2002' },
      { inboundDate: '2025-08-15', startTime: '13:20', endTime: '14:00', supplierCode: 'S078', supplierName: 'åŒ—æµ·ç©€ç‰©', carrierCode: 'T13', carrierName: 'æ±æµ·é‹é€', materialCode: 'M-07', materialName: 'å¤§è±†', form: 'è¢‹ç‰©', weightKg: 24000, cardNo: '2', intakeType: 'ï½¼ï¾ï½ªï½¯ï¾„ï¾Šï¾Ÿï½¯ï½¸', tanks: '115', inboundNo: 'I-2003' },
    ];

    function openShipmentSelector() {
      BASE_DATA.shipment = DUMMY_SHIPMENTS;
      SORT_STATE.shipment = [];
      renderTable('shipmentTable', DUMMY_SHIPMENTS, 'shipment');
      openModal('shipmentModal');
    }

    function openInboundSelector() {
      BASE_DATA.inbound = DUMMY_INBOUNDS;
      SORT_STATE.inbound = [];
      renderTable('inboundTable', DUMMY_INBOUNDS, 'inbound');
      openModal('inboundModal');
    }

    function openModal(id) {
      document.getElementById(id).classList.remove('hidden');
      // Esc ã‚­ãƒ¼ã§é–‰ã˜ã‚‹
      const escHandler = (e) => { if (e.key === 'Escape') { closeModal(id); } };
      document.addEventListener('keydown', escHandler, { once: true });
    }

    function closeModal(id) {
      document.getElementById(id).classList.add('hidden');
    }

    function renderTable(tableId, rows, type) {
      const tbody = document.querySelector(`#${tableId} tbody`);
      tbody.innerHTML = '';

      const columns = type === 'shipment'
        ? [
          { key: 'no', align: 'left' }, { key: 'shipDate', align: 'left' }, { key: 'timeBand', align: 'left' },
          { key: 'deliveryDate', align: 'left' }, { key: 'customerCode', align: 'left' }, { key: 'customerName', align: 'left' },
          { key: 'destinationName', align: 'left' }, { key: 'productCode', align: 'left' }, { key: 'productName', align: 'left' },
          { key: 'status', align: 'left' }, { key: 'form', align: 'left' }, { key: 'quantity', align: 'right' },
          { key: 'weightKg', align: 'right' }, { key: 'gate', align: 'left' }, { key: 'arrived', align: 'left' },
          { key: 'carrierCode', align: 'left' }, { key: 'carrierName', align: 'left' },
        ]
        : [
          { key: 'inboundDate', align: 'left' }, { key: 'startTime', align: 'left' }, { key: 'endTime', align: 'left' },
          { key: 'supplierCode', align: 'left' }, { key: 'supplierName', align: 'left' }, { key: 'carrierCode', align: 'left' },
          { key: 'carrierName', align: 'left' }, { key: 'materialCode', align: 'left' }, { key: 'materialName', align: 'left' },
          { key: 'form', align: 'left' }, { key: 'weightKg', align: 'right' }, { key: 'cardNo', align: 'left' },
          { key: 'intakeType', align: 'left' }, { key: 'tanks', align: 'left' }, { key: 'inboundNo', align: 'left' },
        ];

      for (let i = 0; i < rows.length; i++) {
        const r = rows[i];
        const tr = document.createElement('tr');
        let cells = '';
        for (let c = 0; c < columns.length; c++) {
          const col = columns[c];
          let val = r[col.key] ?? '';
          if (col.key === 'weightKg' && val !== '') val = Number(val).toLocaleString();
          const align = col.align === 'right' ? 'text-right' : '';
          const sticky = c === 0 ? ' sticky left-0 bg-white z-10' : '';
          cells += `<td class="border px-2 py-1 ${align}${sticky}">${val}</td>`;
        }
        cells += `<td class="border px-2 py-1 text-right">
          <button class="text-sm text-white bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded"
                  onclick="selectRecord(${JSON.stringify({})}.constructor(${JSON.stringify(r).replace(/"/g, '&quot;')}) , '${type}')">é¸æŠ</button>
        </td>`;
        tr.innerHTML = cells;
        tr.onclick = (e) => { if (e.target.tagName !== 'BUTTON') selectRecord(r, type); };
        tbody.appendChild(tr);
      }

      enableSorting(tableId, columns, rows, type);
      updateHeaderIndicators(tableId, type); // â† ãƒ˜ãƒƒãƒ€ã«â–²/â–¼ã¨å„ªå…ˆåº¦ã‚’è¡¨ç¤º
    }

    function filterRows(tableId, keyword) {
      const tbody = document.querySelector(`#${tableId} tbody`);
      const q = keyword.trim().toLowerCase();
      for (const tr of tbody.querySelectorAll('tr')) {
        const text = tr.textContent.toLowerCase();
        tr.style.display = text.includes(q) ? '' : 'none';
      }
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ã‚¯ãƒªãƒƒã‚¯ã§ã‚½ãƒ¼ãƒˆ
    function enableSorting(tableId, columns, rows, type) {
      const thead = document.querySelector('#' + tableId + ' thead');

      // æ¯”è¼ƒãƒ˜ãƒ«ãƒ‘ãƒ¼
      const compareValues = (va, vb) => {
        const sva = (va ?? '').toString();
        const svb = (vb ?? '').toString();
        const na = Number(sva.replace(/,/g, ''));
        const nb = Number(svb.replace(/,/g, ''));
        const aIsNum = sva !== '' && !Number.isNaN(na);
        const bIsNum = svb !== '' && !Number.isNaN(nb);
        if (aIsNum && bIsNum) return na - nb;              // æ•°å€¤æ¯”è¼ƒ
        return sva.localeCompare(svb, 'ja');               // æ–‡å­—åˆ—æ¯”è¼ƒï¼ˆæ—¥æœ¬èªï¼‰
      };
      const compareByList = (a, b, list) => {
        for (const { key, dir } of list) {
          const diff = compareValues(a[key], b[key]);
          if (diff !== 0) return diff * dir;
        }
        return 0;
      };

      // é‡è¤‡ãƒã‚¤ãƒ³ãƒ‰é˜²æ­¢
      if (thead.dataset.sortBound === '1') return;
      thead.dataset.sortBound = '1';

      thead.addEventListener('click', (ev) => {
        const th = ev.target.closest('th[data-key]');
        if (!th) return;
        const key = th.getAttribute('data-key');

        let list = SORT_STATE[type] || [];
        const idx = list.findIndex((s) => s.key === key);

        if (idx === -1) {
          // åˆå›ã‚¯ãƒªãƒƒã‚¯: æ˜‡é †ã§æœ«å°¾ã«è¿½åŠ ï¼ˆã‚¯ãƒªãƒƒã‚¯é †ã§å„ªå…ˆåº¦ãŒã¤ãï¼‰
          list = list.concat({ key, dir: 1 });
        } else if (list[idx].dir === 1) {
          // æ˜‡é † â†’ é™é †
          list = list.map((s, i) => (i === idx ? { key: s.key, dir: -1 } : s));
        } else {
          // é™é † â†’ è§£é™¤ï¼ˆãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ï¼‰
          list = list.filter((_, i) => i !== idx);
        }

        SORT_STATE[type] = list;

        const base = BASE_DATA[type] || rows;              // å…ƒé…åˆ—ï¼ˆé–‹ã„ãŸæ™‚ç‚¹ã®é †ï¼‰
        const sorted = list.length ? base.slice().sort((a, b) => compareByList(a, b, list)) : base.slice();

        renderTable(tableId, sorted, type);
      });
    }

    // ãƒ˜ãƒƒãƒ€ã«ã€Œâ–²/â–¼ã€ã¨ä¸¦ã³é †ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤º
    function updateHeaderIndicators(tableId, type) {
      const thead = document.querySelector('#' + tableId + ' thead');
      const list = SORT_STATE[type] || [];
      const indexByKey = new Map(list.map(function (s, i) { return [s.key, { dir: s.dir, idx: i + 1 }]; }));
      thead.querySelectorAll('th[data-key]').forEach(function (th) {
        const key = th.getAttribute('data-key');
        if (!th.dataset.label) th.dataset.label = th.textContent.replace(/[â–²â–¼]\s*\d*$/g, '').trim();
        const baseLabel = th.dataset.label;
        const info = indexByKey.get(key);
        if (info) {
          const arrow = info.dir === 1 ? 'â–²' : 'â–¼';
          th.innerHTML = baseLabel + ' <span class="text-gray-400">' + arrow + '<sup>' + info.idx + '</sup></span>';
        } else {
          th.innerHTML = baseLabel;
        }
      });
    }

    // ---- è¤‡åˆæ¤œç´¢ï¼ˆãƒœã‚¿ãƒ³å¼ï¼‰ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ----
    function parseDate(s) {
      if (!s) return null;
      const d = new Date(s);
      return Number.isNaN(d.getTime()) ? null : d;
    }

    function sortRowsByState(rows, type) {
      const list = SORT_STATE[type] || [];
      if (!list.length) return rows.slice();
      const compareValues = (va, vb) => {
        const sva = (va ?? '').toString();
        const svb = (vb ?? '').toString();
        const na = Number(sva.replace(/,/g, ''));
        const nb = Number(svb.replace(/,/g, ''));
        const aIsNum = sva !== '' && !Number.isNaN(na);
        const bIsNum = svb !== '' && !Number.isNaN(nb);
        if (aIsNum && bIsNum) return na - nb;
        return sva.localeCompare(svb, 'ja');
      };
      const compareByList = (a, b, list2) => {
        for (const { key, dir } of list2) {
          const diff = compareValues(a[key], b[key]);
          if (diff !== 0) return diff * dir;
        }
        return 0;
      };
      return rows.slice().sort((a, b) => compareByList(a, b, list));
    }

    // å‡ºè·ï¼šå‡ºè·æ—¥From-Toã®ã¿
    function applyShipmentFilter() {
      const from = document.getElementById('shipFrom').value;
      const to = document.getElementById('shipTo').value;
      const fromD = parseDate(from);
      const toD = parseDate(to);
      const base = BASE_DATA.shipment || [];
      const filtered = base.filter((r) => {
        const d = parseDate(r.shipDate);
        if (fromD && (!d || d < fromD)) return false;
        if (toD && (!d || d > toD)) return false;
        return true;
      });
      const sorted = sortRowsByState(filtered, 'shipment');
      renderTable('shipmentTable', sorted, 'shipment');
    }
    function resetShipmentFilter() {
      document.getElementById('shipFrom').value = '';
      document.getElementById('shipTo').value = '';
      const base = BASE_DATA.shipment || [];
      const sorted = sortRowsByState(base, 'shipment');
      renderTable('shipmentTable', sorted, 'shipment');
    }

    // å…¥åº«ï¼šå…¥åº«æ—¥From-To + ä»•å…¥å…ˆå/é‹é€ä¼šç¤¾å/åŸæ–™å
    function applyInboundFilter() {
      const from = document.getElementById('inboundFrom').value;
      const to = document.getElementById('inboundTo').value;
      const sName = (document.getElementById('fSupplierName').value || '').trim().toLowerCase();
      const cName = (document.getElementById('fCarrierName').value || '').trim().toLowerCase();
      const mName = (document.getElementById('fMaterialName').value || '').trim().toLowerCase();

      const fromD = parseDate(from);
      const toD = parseDate(to);
      const base = BASE_DATA.inbound || [];
      const filtered = base.filter((r) => {
        const d = parseDate(r.inboundDate);
        if (fromD && (!d || d < fromD)) return false;
        if (toD && (!d || d > toD)) return false;
        if (sName && !(r.supplierName || '').toLowerCase().includes(sName)) return false;
        if (cName && !(r.carrierName || '').toLowerCase().includes(cName)) return false;
        if (mName && !(r.materialName || '').toLowerCase().includes(mName)) return false;
        return true;
      });
      const sorted = sortRowsByState(filtered, 'inbound');
      renderTable('inboundTable', sorted, 'inbound');
    }

    function resetInboundFilter() {
      document.getElementById('inboundFrom').value = '';
      document.getElementById('inboundTo').value = '';
      document.getElementById('fSupplierName').value = '';
      document.getElementById('fCarrierName').value = '';
      document.getElementById('fMaterialName').value = '';
      const base = BASE_DATA.inbound || [];
      const sorted = sortRowsByState(base, 'inbound');
      renderTable('inboundTable', sorted, 'inbound');
    }

    function selectRecord(rec, type) {
      if (type === 'shipment') {
        document.getElementById('shipmentNo').value = rec.no;
        closeModal('shipmentModal');
      } else {
        // å…¥åº«No.ãŒç„¡ã„ã‚±ãƒ¼ã‚¹ã‚’æƒ³å®šâ†’ãƒ¢ãƒƒã‚¯ç”¨ä¸€æ™‚IDã‚’ç”Ÿæˆï¼ˆå®Ÿè£…æ™‚ã¯ã‚µãƒ¼ãƒå´æ¡ç•ªã¨å·®ã—æ›¿ãˆï¼‰
        const tmpId = rec.inboundNo && rec.inboundNo.trim() !== ''
          ? rec.inboundNo
          : `INB-${rec.inboundDate.replaceAll('-', '')}-${rec.supplierCode}-${rec.cardNo}`;
        document.getElementById('shipmentNo').value = tmpId;
        closeModal('inboundModal');
      }
    }
    // <-- å‡ºè·ãƒ»å…¥åº«No.é¸æŠã€€ã“ã“ã¾ã§ -->

    let codeReader;
    async function openBarcodeScanner() {
      const preview = document.getElementById('barcodePreview');
      preview.classList.remove('hidden');
      codeReader = new ZXing.BrowserMultiFormatReader();

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        preview.srcObject = stream;
        preview.play();

        codeReader.decodeFromVideoDevice(null, 'barcodePreview', (result, err) => {
          if (result) {
            document.getElementById('shipmentNo').value = result.text;
            codeReader.reset();
            preview.classList.add('hidden');
            stream.getTracks().forEach(track => track.stop());
          }
        });
      } catch (err) {
        alert("ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸ: " + err.message);
      }
    }

    function startTimer() {
      const shipmentNo = document.getElementById("shipmentNo").value.trim();
      if (!shipmentNo) {
        alert("å‡ºè·No. ã¾ãŸã¯ å…¥åº«No. ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      const carNumber = document.getElementById("carNumber")?.value || '';
      const company = document.getElementById("company")?.value || '';
      const brand = document.getElementById("brand")?.value || '';
      const tankNumber = document.getElementById("tankNumber")?.value || '';
      const remarks = document.getElementById("remarks")?.value || '';

      const now = new Date();
      const startTime = now.toLocaleTimeString();
      const dateStr = now.toISOString().split("T")[0];

      const container = document.createElement("div");
      container.className = "bg-gray-100 border p-4 rounded-lg";

      let sec = 0;
      let isPaused = false;
      let interval;

      const label = document.createElement("div");
      label.innerHTML = `
        <div class="font-semibold text-lg">No: ${shipmentNo}</div>
        <div class="text-sm text-gray-500">é–‹å§‹æ™‚åˆ»: ${startTime}</div>
        <div class="text-sm text-gray-600">ğŸšš ${carNumber || '-'} ï¼ ğŸ¢ ${company || '-'} ï¼ ğŸ§ª ${brand || '-'} ï¼ ğŸ›¢ ${tankNumber || '-'}</div>
        ${remarks ? `<div class="text-sm text-gray-600">ğŸ“ ${remarks}</div>` : ''}
        <div class="text-3xl mt-2 font-mono text-green-600">â± <span id="time">00:00</span></div>
      `;

      const pauseBtn = document.createElement("button");
      pauseBtn.textContent = "â¸ ä¸€æ™‚åœæ­¢";
      pauseBtn.className = "bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600";

      const stopBtn = document.createElement("button");
      stopBtn.textContent = "â¹ çµ‚äº†";
      stopBtn.className = "bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 ml-2";

      const resetBtn = document.createElement("button");
      resetBtn.textContent = "ğŸ” ãƒªã‚»ãƒƒãƒˆ";
      resetBtn.className = "bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 ml-2";

      const timeEl = label.querySelector("#time");

      function updateTime() {
        const m = String(Math.floor(sec / 60)).padStart(2, "0");
        const s = String(sec % 60).padStart(2, "0");
        timeEl.textContent = `${m}:${s}`;
      }

      interval = setInterval(() => {
        if (!isPaused) {
          sec++;
          updateTime();
        }
      }, 1000);

      pauseBtn.onclick = () => {
        isPaused = !isPaused;
        pauseBtn.textContent = isPaused ? "â–¶ å†é–‹" : "â¸ ä¸€æ™‚åœæ­¢";
        pauseBtn.classList.toggle("bg-green-600", isPaused);
        pauseBtn.classList.toggle("bg-yellow-500", !isPaused);
      };

      resetBtn.onclick = () => {
        if (confirm("âš  ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
          sec = 0;
          updateTime();
        }
      };

      stopBtn.onclick = () => {
        clearInterval(interval);
        container.remove();
        const endTime = new Date().toLocaleTimeString();
        const record = {
          date: dateStr,
          shipmentNo,
          startTime,
          endTime,
          duration: timeEl.textContent,
          carNumber,
          company,
          brand,
          tankNumber,
          remarks
        };
        const data = JSON.parse(localStorage.getItem("completedRecords") || "[]");
        data.push(record);
        localStorage.setItem("completedRecords", JSON.stringify(data));
      };

      const btnGroup = document.createElement("div");
      btnGroup.className = "mt-2 flex flex-wrap gap-2";
      btnGroup.appendChild(pauseBtn);
      btnGroup.appendChild(stopBtn);
      btnGroup.appendChild(resetBtn);

      container.appendChild(label);
      container.appendChild(btnGroup);
      document.getElementById("timerList").appendChild(container);
    }
  </script>
</body>

</html>